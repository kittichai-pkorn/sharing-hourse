# Story 3.4: เพิ่มลูกแชร์เข้าวงแชร์

## Info
| Field | Value |
|-------|-------|
| Epic | 4. จัดการลูกแชร์ |
| Priority | P0 |
| Points | 3 (M) |
| Status | 🔲 Todo |

---

## User Story

```
As a: ท้าวแชร์
I want to: เพิ่มลูกแชร์จากระบบเข้าวงแชร์
So that: มีลูกแชร์ครบตามจำนวนที่กำหนด
```

---

## ข้อมูลลูกแชร์ในวง (GroupMember)

| ฟิลด์ | บังคับ | คำอธิบาย |
|-------|--------|----------|
| **memberId** | ใช่ | อ้างอิง Member จากระบบ |
| **ชื่อเล่นในวง** | ไม่ | ชื่อเรียกในวงนี้ (ถ้าไม่ใส่จะใช้ nickname จาก Member) |
| **ยอดส่ง/งวด** | เฉพาะ STEP_INTEREST | ยอดที่ลูกแชร์ส่งทุกงวด (บาท) |

> **Note:** รหัสลูกแชร์ (memberCode) อยู่ที่ Member table
> **Note:** ยอดส่ง/งวด แสดงเฉพาะวง STEP_INTEREST เท่านั้น

---

## Acceptance Criteria

- [ ] Admin เท่านั้นที่เพิ่มได้
- [ ] แสดงรายการลูกแชร์ที่ยังไม่อยู่ในวงนี้
- [ ] แสดงรหัสลูกแชร์ (memberCode) ของแต่ละคน
- [ ] เลือกลูกแชร์แล้วเพิ่มเข้าวง
- [ ] ไม่ให้เพิ่มเกินจำนวนที่กำหนด (maxMembers)
- [ ] ไม่ให้เพิ่มลูกแชร์คนเดิมซ้ำในวงเดียวกัน
- [ ] แสดงข้อความ error ถ้าเกิน
- [ ] **STEP_INTEREST:** แสดงช่องกรอกยอดส่ง/งวด (บังคับ)
- [ ] **STEP_INTEREST:** Validate ยอดส่งต้องมากกว่า 0

---

## UI/UX

### วงทั่วไป
```
┌─────────────────────────────────────────────────────┐
│  เพิ่มลูกแชร์เข้าวง                           [✕]  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                     │
│  เลือกลูกแชร์ *                                    │
│  ┌─────────────────────────────────────────────┐   │
│  │ ○ [A001] พี่ชาย          089-xxx-xxxx      │   │
│  │ ● [A002] น้องหญิง        081-xxx-xxxx  ✓   │   │
│  │ ○ [A003] ลุงศักดิ์        082-xxx-xxxx      │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ชื่อเล่นในวง (ไม่บังคับ)                          │
│  ┌─────────────────────────────────────────────┐   │
│  │ หญิง                                        │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│                              [ยกเลิก] [เพิ่ม]      │
└─────────────────────────────────────────────────────┘
```

### วง STEP_INTEREST (แสดงช่องยอดส่งเพิ่ม)
```
┌─────────────────────────────────────────────────────┐
│  เพิ่มลูกแชร์เข้าวง                           [✕]  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                     │
│  เลือกลูกแชร์ *                                    │
│  ┌─────────────────────────────────────────────┐   │
│  │ ● [A002] น้องหญิง        081-xxx-xxxx  ✓   │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ชื่อเล่นในวง (ไม่บังคับ)                          │
│  ┌─────────────────────────────────────────────┐   │
│  │ หญิง                                        │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ยอดส่ง/งวด (บาท) *                                │
│  ┌─────────────────────────────────────────────┐   │
│  │ 500                                         │   │
│  └─────────────────────────────────────────────┘   │
│  ℹ️ ยอดที่ลูกแชร์ต้องส่งทุกงวด                      │
│                                                     │
│                              [ยกเลิก] [เพิ่ม]      │
└─────────────────────────────────────────────────────┘
```

---

## API

### GET /api/members - ดึงรายการลูกแชร์ทั้งหมด

```typescript
GET /api/members?excludeGroupId=:groupId

// Response
{
  success: true,
  data: [
    {
      id: 1,
      memberCode: "A001",
      nickname: "พี่ชาย",
      phone: "089-xxx-xxxx"
    },
    // ... members not in this group
  ]
}
```

### POST /api/members/group/:groupId - เพิ่มลูกแชร์เข้าวง

```typescript
POST /api/members/group/:groupId

// Request
{
  memberId: number;        // required - ID จาก Member table
  nickname?: string;       // optional - ถ้าไม่ใส่จะใช้ member.nickname
  paymentAmount?: number;  // optional - ยอดส่ง/งวด (บังคับสำหรับ STEP_INTEREST)
}

// Response
{
  success: true,
  data: {
    id: number;            // GroupMember ID
    nickname: string;      // ชื่อเล่นในวง
    memberId: number;
    paymentAmount: number | null;  // ยอดส่ง/งวด
    member: {
      id: number;
      memberCode: "A001";  // from Member table
      nickname: string;
      phone: string | null;
    }
  },
  message: "เพิ่มลูกแชร์เข้าวงเรียบร้อยแล้ว"
}
```

### PUT /api/members/group-member/:id - แก้ไขข้อมูลลูกแชร์ในวง

```typescript
PUT /api/members/group-member/:id

// Request
{
  nickname?: string;       // ชื่อเล่นในวง
  paymentAmount?: number;  // ยอดส่ง/งวด (สำหรับ STEP_INTEREST)
}

// Response
{
  success: true,
  data: {
    id: number;
    nickname: string;
    paymentAmount: number | null;
    member: { ... }
  },
  message: "อัพเดทข้อมูลเรียบร้อยแล้ว"
}
```

---

## Error Cases

| กรณี | ข้อความ |
|------|---------|
| เกิน maxMembers | ลูกแชร์ครบแล้ว |
| Member ซ้ำในวง | ลูกแชร์นี้อยู่ในวงแล้ว |
| ไม่พบ Member | ไม่พบลูกแชร์ |
| วงเปิดแล้ว | ไม่สามารถเพิ่มลูกแชร์หลังวงเปิดแล้ว |
| STEP_INTEREST ไม่กรอกยอดส่ง | กรุณากรอกยอดส่ง/งวด |
| ยอดส่ง <= 0 | ยอดส่งต้องมากกว่า 0 |

---

## Files

- `backend/src/routes/members.ts` - GET /api/members, POST /api/members/group/:groupId
- `frontend/src/pages/dashboard/ShareGroupDetailPage.tsx` - Add ลูกแชร์ to Group Modal

---

## Notes

- ลูกแชร์ 1 คนสามารถอยู่หลายวงได้
- GroupMember.nickname สามารถต่างจาก Member.nickname ได้ (ชื่อเล่นเฉพาะวง)
- รหัสลูกแชร์ (memberCode) อยู่ที่ Member table (ใช้ร่วมกันทุกวง)

---

*v4.0 | Dec 2024 - เพิ่มยอดส่ง/งวด สำหรับ STEP_INTEREST*
