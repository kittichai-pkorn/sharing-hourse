# Story 6.2: แสดงรายการหักรับของงวด

## Info
| Field | Value |
|-------|-------|
| Epic | 6. รายการหักรับ |
| Priority | P1 |
| Points | 2 (S) |

---

## User Story

```
As a: ท้าวแชร์
I want to: เห็นรายการหักรับของแต่ละงวด พร้อมระบบ Auto-fill ตามประเภทวง
So that: รู้ว่าหักอะไรบ้าง และไม่ต้องกรอกข้อมูลซ้ำทุกงวด
```

---

## Acceptance Criteria

- [x] แสดงรายการหักรับทั้งหมด
- [x] แสดงดอกเบี้ย (Auto จากประเภทวง)
- [x] แสดงค่าดูแลวง (Auto จาก managementFee)
- [x] แสดงยอดรวมหักรับ
- [x] แสดงเงินที่ผู้ชนะได้รับจริง
- [x] สามารถเพิ่ม/แก้ไข/ลบรายการหักรับเพิ่มเติมได้

---

## Auto-fill Logic ตามประเภทวง

### ดอกเบี้ย (Interest)

| ประเภทวง | การคำนวณดอกเบี้ย |
|---------|-----------------|
| `STEP_INTEREST` (ขั้นบันได) | ดึงจาก `interestRate` ที่กำหนดไว้ในวง × งวดที่ |
| `BID_INTEREST` (บิทดอกตาม) | ดึงจาก `winningBid` (ยอดประมูลที่ชนะ) |
| `FIXED_INTEREST` (ดอกตาม) | ดึงจาก `interestRate` ที่กำหนดไว้ในวง |
| `BID_PRINCIPAL` (บิทลดต้น-หักดอกท้าย) | ดึงจาก `winningBid` (ยอดประมูลที่ชนะ) |
| `BID_PRINCIPAL_FIRST` (บิทลดต้น-หักดอกหน้า) | ดึงจาก `winningBid` (ยอดประมูลที่ชนะ) |

### ค่าดูแลวง (Management Fee)

- ดึงจาก `ShareGroup.managementFee`
- **แสดงเสมอ** - ถ้าไม่มีค่า (null) = แสดงเป็น 0 บาท
- สามารถแก้ไขได้

### ดอกเบี้ย (Interest) - แสดงเสมอ

- **แสดงเสมอ** - ถ้าไม่มีค่าหรือเป็นงวดแรก = แสดงเป็น 0 บาท
- คำนวณตามประเภทวง:
  - `STEP_INTEREST`: interestRate × งวดที่ (ถ้าไม่มี interestRate = 0)
  - `FIXED_INTEREST`: interestRate (ถ้าไม่มี interestRate = 0)
  - `BID_INTEREST`: winningBid (ถ้ายังไม่ประมูล = 0)
- สามารถแก้ไขได้

### รายการหักรับอื่นๆ

- ดึงจาก `GroupDeductionTemplate` ที่กำหนดไว้ตอนสร้างวง
- สามารถเพิ่ม/แก้ไข/ลบได้ในแต่ละงวด

---

## UI/UX

```
┌─────────────────────────────────────────────────────┐
│  รายการหักรับ - งวดที่ 3                     [X]  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                     │
│  กำหนดชำระ: 15 ม.ค. 68                              │
│  ผู้ชนะ: พี่เอ                                      │
│                                                     │
│  รายการหักรับ                      + เพิ่มรายการ  │
│  ┌─────────────────────────────────────────────┐   │
│  │ [ค่าดูแลวง    ] [  100  ] บาท  [X]         │   │
│  │ [ดอกเบี้ย     ] [   80  ] บาท  [X]         │   │
│  │ [หักท้ายท้าว  ] [  200  ] บาท  [X]         │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ รวมหักรับ:              380 บาท            │   │
│  │ ─────────────────────────────────           │   │
│  │ เงินกองกลาง:         20,000 บาท            │   │
│  │ ผู้ชนะได้รับ:        19,620 บาท            │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  [ปิด]                              [บันทึก]       │
└─────────────────────────────────────────────────────┘
```

**หมายเหตุ:**
- ค่าดูแลวง และ ดอกเบี้ย จะแสดงเสมอ (แม้เป็น 0)
- ทุกรายการสามารถแก้ไขได้

---

## Data Flow

```
เมื่อเปิด Modal:
  1. ดึง Round data (winningBid, status, roundNumber)
  2. ดึง ShareGroup data (type, interestRate, managementFee)
  3. ดึง GroupDeductionTemplate (รายการหักรับ template)
  4. ดึง Deduction ที่บันทึกไว้แล้ว (ถ้ามี)

  5. Auto-fill (แสดงเสมอ):
     - ค่าดูแลวง: managementFee หรือ 0
     - ดอกเบี้ย: คำนวณตาม type หรือ 0
     - รายการอื่นๆ: จาก template

  6. Merge กับ saved deductions:
     - ถ้ามี saved ที่ชื่อตรงกัน → ใช้ค่าจาก saved
     - ถ้าไม่มี → ใช้ค่า auto-fill

เมื่อบันทึก:
  1. บันทึก Deduction records ลง DB (รวม ค่าดูแล และ ดอกเบี้ย)
  2. อัพเดท Round.payoutAmount
```

---

## API

```
GET /api/deductions/round/:roundId
Response: {
  success: true,
  data: [
    { id: 1, type: "OTHER", amount: 100, note: "ค่าดูแลวง" },
    { id: 2, type: "OTHER", amount: 200, note: "หักท้ายท้าว" }
  ]
}

POST /api/deductions/round/:roundId
Body: {
  deductions: [
    { name: "ค่าดูแลวง", amount: 100 },
    { name: "หักท้ายท้าว", amount: 200 }
  ]
}
```

---

## Technical Notes

- **ค่าดูแลวง** และ **ดอกเบี้ย** จะแสดงเสมอ (แม้เป็น 0) และสามารถแก้ไขได้
- รายการหักรับทุกรายการสามารถแก้ไข/ลบได้
- เมื่อเปิด Modal จะ merge auto-fill กับ saved deductions
- ลำดับการแสดง: ค่าดูแลวง → ดอกเบี้ย → รายการจาก template → รายการเพิ่มเติม

---

## Group Info Section

แสดงข้อมูลวงในส่วน "Group Info" บน ShareGroupDetailPage

### ข้อมูลที่แสดง (แสดงเสมอ)

| Field | ค่า | หมายเหตุ |
|-------|-----|---------|
| ประเภท | typeLabels[group.type] | - |
| เงินต้น | principalAmount | บาท/คน |
| ลูกแชร์ | members.length / maxMembers | คน |
| เงินกองกลาง | principalAmount × maxMembers | บาท/งวด |
| **ค่าดูแลวง** | managementFee \|\| 0 | บาท (แสดง 0 ถ้าไม่มี) |
| **ดอกเบี้ย** | interestRate \|\| 0 | บาท (แสดง 0 ถ้าไม่มี) |

### UI Mockup

```
┌─────────────────────────────────────────────────────────────────┐
│  ชื่อวง                                    [เปิดวง] [ยกเลิก]   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                 │
│  ประเภท:        เงินต้น:       ลูกแชร์:      เงินกองกลาง:       │
│  ขั้นบันได      10,000 บาท    5/5 คน       50,000 บาท         │
│                                                                 │
│  ค่าดูแลวง:     ดอกเบี้ย:                                       │
│  500 บาท        100 บาท                                        │
└─────────────────────────────────────────────────────────────────┘
```

### หมายเหตุ
- ดอกเบี้ยแสดงตาม `interestRate` ในวง (สำหรับ STEP_INTEREST, FIXED_INTEREST)
- สำหรับ BID_INTEREST ไม่ต้องแสดง ดอกเบี้ย เพราะเป็นประมูล
