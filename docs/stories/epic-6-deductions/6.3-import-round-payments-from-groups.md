# Story 6.3: ดึง Round Payment ของสมาชิกจากวงอื่น

## Info
| Field | Value |
|-------|-------|
| Epic | 6. รายการหักรับ |
| Priority | P2 |
| Points | 3 (M) |

---

## User Story

```
As a: ท้าวแชร์
I want to: ดึงข้อมูลการชำระเงินของสมาชิกคนนั้นจากวงแชร์อื่นที่เล่นอยู่
So that: เพื่อใช้ในการหักรับเงิน
```

---

## Background

- สมาชิกบางคนอาจเล่นแชร์หลายวงกับท้าวคนเดียวกัน
- ท้าวต้องการดึงข้อมูล round payment มาหักรับ
- ถ้าสมาชิกค้างชำระจากวงอื่น สามารถหักจากเงินที่ได้รับในวงนี้ได้

---

## Acceptance Criteria

- [ ] ใน Round Deduction Modal มีปุ่ม "ดึงยอดจากวงอื่น" สำหรับแต่ละสมาชิก
- [ ] กดปุ่มแล้วแสดงวงแชร์อื่นที่สมาชิกคนนั้นเล่นอยู่ (status = OPEN)
- [ ] ไม่แสดงวงปัจจุบันใน dropdown
- [ ] เลือกวงแล้วแสดงรายการ round payment ที่ค้างชำระ
- [ ] สามารถเลือก payment ที่ค้างชำระ แล้วเพิ่มเป็นรายการหักรับได้
- [ ] รายการหักรับที่นำเข้าจะแสดงชื่อวงต้นทางด้วย

---

## UI/UX

### 1. ปุ่มดึงยอดในหน้ารายการหักรับ

```
┌─────────────────────────────────────────────────────────────┐
│  รายการหักรับ - งวดที่ 3                              [X]  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                             │
│  สมาชิก: น้องแอ๋ม (A002)                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ รายการหักรับ                    [+ ดึงยอดจากวงอื่น] │   │
│  │                                                     │   │
│  │ ☑ ค่าดูแล                              500 บาท     │   │
│  │ ☑ ค่าธรรมเนียม                         100 บาท     │   │
│  │                                                     │   │
│  │ รวมหัก: 600 บาท                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. Modal เลือกวงและ Payment ที่ค้าง

```
┌─────────────────────────────────────────────────────────────┐
│  ดึงยอดค้างชำระของ น้องแอ๋ม                          [X]  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                             │
│  เลือกวง:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ▼ วงบ้านพี่เอ (ขั้นบันได, 10 คน)                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  รายการค้างชำระ:                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ☐ งวด 2 │ 10,000 บาท │ กำหนด 15 ก.พ.               │   │
│  │ ☐ งวด 4 │ 10,000 บาท │ กำหนด 15 เม.ย.              │   │
│  │ ☐ งวด 5 │ 10,000 บาท │ กำหนด 15 พ.ค.               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  รวมที่เลือก: 20,000 บาท (2 รายการ)                       │
│                                                             │
│  [ยกเลิก]                         [เพิ่มเป็นรายการหักรับ]  │
└─────────────────────────────────────────────────────────────┘
```

### 3. รายการหักรับหลังนำเข้า

```
┌─────────────────────────────────────────────────────────────┐
│  รายการหักรับ                      [+ ดึงยอดจากวงอื่น]     │
│                                                             │
│  ☑ ค่าดูแล                                    500 บาท     │
│  ☑ ค่าธรรมเนียม                               100 บาท     │
│  ☑ ค้างวงบ้านพี่เอ งวด 2                   10,000 บาท     │
│  ☑ ค้างวงบ้านพี่เอ งวด 4                   10,000 บาท     │
│                                                             │
│  รวมหัก: 20,600 บาท                                        │
└─────────────────────────────────────────────────────────────┘
```

---

## Data Flow

```
1. เปิด Round Deduction Modal สำหรับสมาชิก
2. กดปุ่ม "ดึงยอดจากวงอื่น"
3. API: GET /api/members/:memberId/groups?status=OPEN&excludeGroupId=X
   → ได้รายการวงที่สมาชิกเล่นอยู่
4. เลือกวง
5. API: GET /api/members/:memberId/round-payments?groupId=Y&status=PENDING
   → ได้รายการ payment ที่ค้างชำระ
6. เลือก payment ที่ต้องการหักรับ
7. กด "เพิ่มเป็นรายการหักรับ"
8. เพิ่มรายการหักรับใหม่ในหน้า Round Deduction
   → ชื่อ: "ค้าง{วง} งวด {X}"
   → จำนวน: ยอดที่ค้าง
```

---

## API

### 1. ดึงวงอื่นที่ผู้ชนะเล่นอยู่ (ใช้ groupMemberId)

```
GET /api/members/group-member/:groupMemberId/other-groups?status=OPEN

Response: {
  success: true,
  data: {
    memberId: 5,
    memberName: "น้องแอ๋ม",
    groups: [
      { id: 1, name: "วงบ้านพี่เอ", type: "STEP_INTEREST", maxMembers: 10, status: "OPEN", groupMemberId: 12 },
      { id: 2, name: "วงแชร์ครอบครัว", type: "BID_INTEREST", maxMembers: 5, status: "OPEN", groupMemberId: 25 }
    ]
  }
}
```

### 2. ดึง Round Payment ที่ค้างชำระจากวงเป้าหมาย

```
GET /api/members/group-member/:groupMemberId/pending-payments?targetGroupId=Y

Response: {
  success: true,
  data: {
    groupId: 1,
    groupName: "วงบ้านพี่เอ",
    memberId: 5,
    memberName: "น้องแอ๋ม",
    pendingPayments: [
      {
        roundId: 2,
        roundNumber: 2,
        amount: 10000,
        dueDate: "2025-02-15"
      },
      {
        roundId: 4,
        roundNumber: 4,
        amount: 10000,
        dueDate: "2025-04-15"
      }
    ]
  }
}
```

---

## Technical Notes

### การเพิ่มรายการหักรับจากวงอื่น

```typescript
// เมื่อเลือก payment ที่ค้างชำระ
const importedDeductions = selectedPayments.map(payment => ({
  name: `ค้าง${groupName} งวด ${payment.roundNumber}`,
  amount: payment.amount,
  sourceGroupId: groupId,        // เก็บ reference วงต้นทาง
  sourceRoundId: payment.roundId // เก็บ reference งวดต้นทาง
}));

// เพิ่มเข้า roundDeductionItems
setRoundDeductionItems([...roundDeductionItems, ...importedDeductions]);
```

### โครงสร้างข้อมูลรายการหักรับ

```typescript
interface DeductionItem {
  id?: number;
  name: string;
  amount: number;
  sourceGroupId?: number;   // ถ้ามาจากวงอื่น
  sourceRoundId?: number;   // งวดที่ค้างจากวงอื่น
}
```

---

## Edge Cases

| Case | Behavior |
|------|----------|
| สมาชิกไม่ได้เล่นวงอื่น | แสดงข้อความ "สมาชิกนี้ไม่ได้เล่นวงอื่นที่เปิดอยู่" |
| ไม่มียอดค้างชำระ | แสดงข้อความ "ไม่มียอดค้างชำระในวงนี้" |
| เลือกยอดซ้ำ | ป้องกันการเพิ่มซ้ำ โดยเช็ค sourceGroupId + sourceRoundId |

---

## Files to Modify

### Backend
- `backend/src/routes/members.ts`
  - แก้ไข GET `/api/members/:memberId/round-payments` ให้รองรับ filter status=PENDING

### Frontend
- `frontend/src/pages/dashboard/ShareGroupDetailPage.tsx`
  - เพิ่มปุ่ม "ดึงยอดจากวงอื่น" ใน Round Deduction section
  - เพิ่ม Modal สำหรับเลือกวงและ payment
  - เพิ่ม logic สำหรับ import payment เป็นรายการหักรับ

---

## Implementation Status

- [x] Backend: GET /api/members/group-member/:groupMemberId/other-groups
- [x] Backend: GET /api/members/group-member/:groupMemberId/pending-payments
- [x] Frontend: Tab "ดึงจากวงอื่น" ใน Round Deduction Modal
- [x] Frontend: แสดงวงที่ผู้ชนะเล่นอยู่
- [x] Frontend: แสดงรายการค้างชำระและเลือกได้
- [x] Frontend: Logic import เป็นรายการหักรับ

---

*Updated: Dec 24, 2024*
