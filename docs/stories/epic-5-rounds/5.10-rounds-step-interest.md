# Story 5.10: Tab งวด - วงขั้นบันได (STEP_INTEREST)

## Info
| Field | Value |
|-------|-------|
| Epic | 5. จัดการงวด |
| Priority | P1 |
| Points | 3 (M) |
| Status | ✅ Done |

---

## User Story

```
As a: ท้าวแชร์
I want to: ดู tab งวด ที่แสดงข้อมูลเฉพาะสำหรับวงขั้นบันได
So that: เข้าใจยอดส่งและยอดรับของแต่ละงวดได้ถูกต้อง
```

---

## Background

วงขั้นบันได (STEP_INTEREST) มีลักษณะเฉพาะ:
- **กำหนดลูกแชร์ล่วงหน้า** ไม่มีการประมูล/จับฉลาก
- แต่ละคนมี **ยอดส่ง (ดอก) คงที่ต่างกัน** ตลอดวง
- ท้าวได้งวดแรก รับ = ผลรวมยอดส่งทั้งหมด
- ลูกแชร์รับ = เงินต้น - ยอดส่งคนอื่น - ยอดส่งตัวเอง
- **ไม่มีแนวคิด "ผู้ชนะ"** แต่เป็น "ผู้ได้รับเงินงวดนี้"

---

## Acceptance Criteria

- [x] แสดงคอลัมน์ "ลูกแชร์" แทน "ผู้ชนะ"
- [x] แสดง dropdown เลือกลูกแชร์สำหรับแต่ละงวด (กำหนดล่วงหน้า)
- [x] แสดงคอลัมน์ "ยอดส่ง" ของลูกแชร์คนนั้น
- [x] สามารถแก้ไขยอดส่งได้ (คลิกที่ตัวเลข → แก้ไข → บันทึก)
- [x] แสดงยอดรับ (คำนวณจากสูตร)
- [x] เมื่อกำหนดลูกแชร์แล้ว คำนวณยอดรับอัตโนมัติ

---

## UI/UX - ตาราง tab งวด

```
┌───────┬────────────┬──────────────┬──────────┬──────────┬────────┐
│ งวด   │ กำหนดชำระ  │ ลูกแชร์       │ ยอดรับ    │ ยอดส่ง   │ จัดการ │
├───────┼────────────┼──────────────┼──────────┼──────────┼────────┤
│ 1     │ 1 ม.ค. 68  │ ป้าแดง (ท้าว) │ 640      │ 0        │ [จัดการ]│
│ 2     │ 1 ก.พ. 68  │ [เต้ ▼]      │ 360      │ 240 ✎   │ [จัดการ]│
│ 3     │ 1 มี.ค. 68 │ [เลือก ▼]    │ -        │ -        │ [จัดการ]│
│ 4     │ 1 เม.ย. 68 │ [เลือก ▼]    │ -        │ -        │ [จัดการ]│
└───────┴────────────┴──────────────┴──────────┴──────────┴────────┘
```

**หมายเหตุ:**
- งวด 1 = ท้าวเสมอ (แก้ไขไม่ได้)
- งวด 2+ = dropdown เลือกลูกแชร์ (เลือกได้เฉพาะคนที่ยังไม่ได้กำหนด)
- ✎ = คลิกแก้ไขยอดส่ง

---

## Flow การกำหนดลูกแชร์

1. **ตอนสร้างวง** - เพิ่มสมาชิกพร้อมยอดส่งของแต่ละคน
2. **tab งวด** - กำหนดว่าใครได้งวดไหน (assign)
3. **เมื่อกำหนดแล้ว** - ระบบคำนวณยอดรับอัตโนมัติ

---

## สูตรคำนวณยอดรับ

### งวดแรก (ท้าว)
```
ยอดรับท้าว = ผลรวมยอดส่งลูกแชร์ทั้งหมด
```

**ตัวอย่าง:**
- เต้ ส่ง 240
- เต้ง ส่ง 220
- ทิม ส่ง 180
- **ท้าวรับ = 240 + 220 + 180 = 640 บาท**

### งวดอื่นๆ (ลูกแชร์)
```
ยอดรับ = เงินต้น - ยอดส่งคนอื่น - ยอดส่งตัวเอง
```

**ตัวอย่าง:** เต้ได้งวด 2 (เงินต้น 1000)
- ยอดส่งคนอื่น = 220 + 180 = 400
- ยอดส่งตัวเอง = 240
- **เต้รับ = 1000 - 400 - 240 = 360 บาท**

---

## ความแตกต่างจากประเภทอื่น

| รายการ | STEP_INTEREST | FIXED_INTEREST | BID_INTEREST |
|--------|---------------|----------------|--------------|
| วิธีได้งวด | กำหนดล่วงหน้า | จับฉลาก | ประมูล |
| ยอดส่งแต่ละคน | ต่างกัน (ดอก) | เท่ากัน | เท่ากัน |
| คอลัมน์ดอกเบี้ย | ไม่แสดง | แสดง (คงที่) | แสดง (ประมูล) |
| คอลัมน์ยอดส่ง | แสดง | ไม่แสดง | ไม่แสดง |
| แก้ไขยอดส่งได้ | ได้ | ไม่ได้ | ไม่ได้ |

---

## Technical Notes

### Database
- `Round.winnerId` → ใช้เป็น `assignedMemberId` (ผู้ได้งวดนี้)
- `GroupMember.paymentAmount` → ยอดส่งของลูกแชร์แต่ละคน

### API
- `PUT /api/rounds/:id/assign` - กำหนดลูกแชร์ให้งวด
- `PUT /api/members/group-member/:id` - แก้ไขยอดส่ง

### Frontend
- แสดง dropdown เลือกลูกแชร์ (ยกเว้นงวดแรก)
- คำนวณยอดรับทันทีเมื่อกำหนดลูกแชร์
- แก้ไขยอดส่งได้ inline

---

## Files

- `frontend/src/pages/dashboard/ShareGroupDetailPage.tsx`
- `backend/src/routes/rounds.ts`

---

*v1.1 | Dec 2024*
