# Story 5.7: บันทึกการชำระเงินของลูกแชร์

## Info
| Field | Value |
|-------|-------|
| Epic | 5. จัดการงวด |
| Priority | P1 |
| Points | 3 (M) |

---

## User Story

```
As a: ท้าวแชร์
I want to: บันทึกการชำระเงินของลูกแชร์แต่ละคนในแต่ละงวด
So that: ติดตามสถานะการชำระเงินและรู้ว่าใครยังไม่ชำระ
```

---

## Acceptance Criteria

- [ ] แสดงรายชื่อลูกแชร์ที่ต้องชำระในแต่ละงวด
- [ ] สามารถ tick ✓ ว่าลูกแชร์คนนั้นชำระแล้ว
- [ ] แสดงสถานะ: ยังไม่ชำระ / ชำระแล้ว
- [ ] แสดงจำนวนคนที่ชำระแล้ว / ทั้งหมด
- [ ] สามารถยกเลิกการชำระได้ (กรณีบันทึกผิด)
- [ ] บันทึกวันที่และเวลาที่ชำระ
- [ ] แสดงใน "ตารางชำระรายบุคคล"

---

## Database Schema

### ตาราง RoundPayment (ใหม่)

```prisma
model RoundPayment {
  id            Int         @id @default(autoincrement())
  roundId       Int
  groupMemberId Int
  amount        Int         // จำนวนเงินที่ชำระ (= principalAmount)
  paidAt        DateTime?   // วันที่ชำระ (null = ยังไม่ชำระ)
  note          String?     // หมายเหตุ
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  round         Round       @relation(fields: [roundId], references: [id], onDelete: Cascade)
  groupMember   GroupMember @relation(fields: [groupMemberId], references: [id], onDelete: Cascade)

  @@unique([roundId, groupMemberId])
}
```

---

## UI/UX

### ตำแหน่ง UI

อยู่ใน Modal "รายการหักรับ" ของแต่ละงวด เพิ่ม tab "การชำระเงิน"

### Modal รายการหักรับ - เพิ่ม Tab

```
┌─────────────────────────────────────────────────────────────────┐
│  งวดที่ 2 - 15 ก.พ. 68                                    [✕]  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                 │
│  [รายการหักรับ]  [การชำระเงิน 3/4]                             │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  💰 เงินต้น: 10,000 บาท/คน                                     │
│  ✅ ชำระแล้ว: 3/4 คน (30,000/40,000 บาท)                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ [✓] ป้าเล็ก (M001)       10,000 บาท    15 ก.พ. 68 10:30 │   │
│  │ [✓] น้องแอ๋ม (M002)      10,000 บาท    15 ก.พ. 68 11:00 │   │
│  │ [✓] ลุงสมบัติ (M003)     10,000 บาท    15 ก.พ. 68 09:15 │   │
│  │ [ ] พี่นก (M004)         10,000 บาท    ยังไม่ชำระ        │   │
│  │ --- ป้าแดง (ท้าว) ---    🎉 เปียงวดนี้                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  [ปิด]                                         [บันทึก]        │
└─────────────────────────────────────────────────────────────────┘
```

### สถานะการชำระ

| สถานะ | Icon | สี |
|-------|------|-----|
| ยังไม่ชำระ | [ ] | เทา |
| ชำระแล้ว | [✓] | เขียว |
| เปียงวดนี้ | 🎉 | - (ไม่ต้องชำระ) |

---

## API

### GET /api/rounds/:roundId/payments

ดึงรายการชำระเงินของงวด

```json
{
  "success": true,
  "data": {
    "roundId": 2,
    "roundNumber": 2,
    "dueDate": "2025-02-15",
    "principalAmount": 10000,
    "totalMembers": 5,
    "paidCount": 3,
    "paidAmount": 30000,
    "totalAmount": 40000,
    "winnerId": 5,
    "payments": [
      {
        "id": 1,
        "groupMemberId": 1,
        "memberCode": "M001",
        "nickname": "ป้าเล็ก",
        "isHost": false,
        "isWinner": false,
        "amount": 10000,
        "isPaid": true,
        "paidAt": "2025-02-15T10:30:00Z",
        "note": null
      },
      {
        "groupMemberId": 5,
        "nickname": "ป้าแดง",
        "isHost": true,
        "isWinner": true,
        "amount": 0,
        "isPaid": null,
        "note": "เปียงวดนี้"
      }
    ]
  }
}
```

### POST /api/rounds/:roundId/payments

บันทึกการชำระเงิน

```json
// Request
{
  "payments": [
    { "groupMemberId": 1, "isPaid": true },
    { "groupMemberId": 2, "isPaid": true },
    { "groupMemberId": 3, "isPaid": true },
    { "groupMemberId": 4, "isPaid": false }
  ]
}

// Response
{
  "success": true,
  "message": "บันทึกการชำระเงินเรียบร้อยแล้ว"
}
```

### PUT /api/rounds/:roundId/payments/:groupMemberId

อัปเดตการชำระเงินรายคน

```json
// Request
{ "isPaid": true, "note": "โอนผ่าน PromptPay" }

// Response
{
  "success": true,
  "data": {
    "id": 1,
    "groupMemberId": 1,
    "isPaid": true,
    "paidAt": "2025-02-15T10:30:00Z",
    "note": "โอนผ่าน PromptPay"
  }
}
```

---

## Logic

### สร้าง RoundPayment records

```
เมื่อเปิดวง (status = OPEN):
  สำหรับแต่ละงวด:
    สำหรับแต่ละสมาชิก:
      ถ้า สมาชิกไม่ใช่ผู้ชนะงวดนี้:
        สร้าง RoundPayment {
          roundId: round.id,
          groupMemberId: member.id,
          amount: principalAmount,
          paidAt: null
        }
```

### ผู้ชนะไม่ต้องชำระ

```
ผู้ชนะของงวดนั้น:
  - ไม่สร้าง RoundPayment record
  - แสดงเป็น "🎉 เปียงวดนี้"
  - ไม่นับใน paidCount/totalMembers
```

---

## UI Flow

1. ท้าวแชร์เปิด Modal "จัดการ" ของงวดที่ต้องการ
2. กดแท็บ "การชำระเงิน"
3. เห็นรายชื่อลูกแชร์ทั้งหมด (ยกเว้นผู้ชนะ)
4. Tick ✓ ที่ลูกแชร์ที่ชำระแล้ว
5. กด "บันทึก"
6. ระบบบันทึก paidAt = now()

---

## Integration กับ Payment Schedule

ใน "ตารางชำระรายบุคคล":
- สถานะ PAID = มี RoundPayment.paidAt
- สถานะ PENDING = ไม่มี paidAt หรือ paidAt = null
- สถานะ WON = เป็นผู้ชนะงวดนั้น

---

## Technical Notes

- RoundPayment สร้างเมื่อเปิดวง (หรือ lazy create เมื่อเปิด Modal)
- ผู้ชนะแต่ละงวดไม่มี RoundPayment (ไม่ต้องชำระ)
- paidAt = null หมายถึงยังไม่ชำระ
- การ toggle isPaid จะ set/unset paidAt

---

## Future Enhancements

- [ ] แจ้งเตือนลูกแชร์ที่ยังไม่ชำระ
- [ ] รายงานสรุปการชำระเงิน
- [ ] Export รายการชำระเป็น Excel
- [ ] แนบหลักฐานการโอนเงิน (รูปสลิป)
