# Story 5.6: ตารางวันที่ต้องชำระของลูกแชร์

## Info
| Field | Value |
|-------|-------|
| Epic | 5. จัดการงวด |
| Priority | P1 |
| Points | 2 (S) |

---

## User Story

```
As a: ท้าวแชร์
I want to: เห็นตารางวันที่ต้องชำระของลูกแชร์แต่ละคนหลังเปิดวง
So that: แจ้งลูกแชร์ล่วงหน้าและติดตามการชำระเงินได้
```

---

## Acceptance Criteria

- [ ] แสดงตารางวันที่ต้องชำระหลังเปิดวง
- [ ] แสดงรายชื่อลูกแชร์ทุกคน
- [ ] แสดงวันที่ต้องชำระของแต่ละงวด
- [ ] แสดงจำนวนเงินที่ต้องชำระ (เงินต้น)
- [ ] แสดงสถานะ (รอชำระ / ชำระแล้ว / เปียแล้ว)
- [ ] สามารถดาวน์โหลด/แชร์ตารางได้ (optional)
- [ ] แสดงเฉพาะเมื่อวงมีสถานะ OPEN หรือ IN_PROGRESS

---

## UI Placement

อยู่ใน Tab "งวด" ที่ column "จัดการ" โดยเพิ่มปุ่ม "ตารางชำระ" ข้างปุ่ม "จัดการ" เดิม

---

## UI/UX

### Tab งวด - เพิ่มปุ่มตารางชำระ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  👥 ลูกแชร์ 5/5    📅 งวด 1/5    📊 รายงาน                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [Timeline: ①-②-③-④-⑤]                                                    │
│                                                                             │
│  ┌──────┬────────────┬────────┬────────┬──────────┬──────────┬───────────┐ │
│  │ งวด  │ กำหนดชำระ   │ สถานะ  │ ผู้ชนะ  │ ดอกเบี้ย  │ ได้รับ    │ จัดการ     │ │
│  ├──────┼────────────┼────────┼────────┼──────────┼──────────┼───────────┤ │
│  │  1   │ 15 ม.ค. 68 │ สำเร็จ │ ป้าแดง │ -        │ 50,000   │ จัดการ    │ │
│  │  2   │ 15 ก.พ. 68 │ รอ     │ -      │ -        │ -        │ จัดการ    │ │
│  │  ...                                                                    │ │
│  └──────┴────────────┴────────┴────────┴──────────┴──────────┴───────────┘ │
│                                                                             │
│                                            [📅 ตารางชำระทั้งหมด]           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Modal ตารางชำระ (เปิดจากปุ่ม "ตารางชำระทั้งหมด")

```
┌─────────────────────────────────────────────────────────────────┐
│  📅 ตารางชำระรายบุคคล                         [ขยาย/ย่อทั้งหมด] │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                 │
│  ▼ ป้าเล็ก (M001)                                              │
│  ┌──────┬────────────┬────────────┬─────────────┐              │
│  │ งวด  │ วันที่      │ ต้องชำระ   │ สถานะ       │              │
│  ├──────┼────────────┼────────────┼─────────────┤              │
│  │  1   │ 15 ม.ค. 68 │ 10,000     │ ⏳ รอชำระ   │              │
│  │  2   │ 15 ก.พ. 68 │ 10,000     │ ⏳ รอชำระ   │              │
│  │  3   │ 15 มี.ค. 68│ 🎉 เปีย    │ ได้รับเงิน  │              │
│  │  4   │ 15 เม.ย. 68│ 10,000     │ ⏳ รอชำระ   │              │
│  │  5   │ 15 พ.ค. 68 │ 10,000     │ ⏳ รอชำระ   │              │
│  └──────┴────────────┴────────────┴─────────────┘              │
│  รวมต้องชำระ: 40,000 บาท (4 งวด)                               │
│                                                                 │
│  ▶ น้องแอ๋ม (M002)                                             │
│  ▶ ลุงสมบัติ (M003)                                            │
│  ▶ พี่นก (M004)                                                │
│  ▶ ป้าแดง (ท้าว) - เปียงวด 1                                   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  💡 ลูกแชร์ทุกคนต้องชำระเงินต้นทุกงวด                          │
│     ยกเว้นงวดที่ตัวเองเปีย (จะได้รับเงินแทน)                   │
│     รวมชำระ = (จำนวนงวด - 1) × เงินต้น                         │
│                                                                 │
│  [📋 คัดลอก]  [📤 แชร์ LINE]                          [ปิด]    │
└─────────────────────────────────────────────────────────────────┘
```

---

## Data Structure

### Payment Schedule Response

```typescript
interface PaymentSchedule {
  groupId: number;
  groupName: string;
  principalAmount: number;
  totalRounds: number;
  rounds: {
    roundNumber: number;
    dueDate: string;
    winnerId: number | null;
    winnerName: string | null;
    status: 'PENDING' | 'COMPLETED';
  }[];
  members: {
    id: number;
    memberCode: string;
    nickname: string;
    isHost: boolean;
    wonRound: number | null;
    payments: {
      roundNumber: number;
      dueDate: string;
      amount: number;         // เงินที่ต้องชำระ (0 ถ้าเปียงวดนี้)
      status: 'PENDING' | 'PAID' | 'WON';
    }[];
    totalPayment: number;     // รวมเงินที่ต้องชำระทั้งหมด
    totalPaid: number;        // รวมเงินที่ชำระแล้ว
  }[];
}
```

---

## API

```
GET /api/share-groups/:id/payment-schedule
Response: {
  success: true,
  data: PaymentSchedule
}
```

---

## Logic

### Business Rule

```
- ลูกแชร์ทุกคนมีรายการชำระ = จำนวนงวด (ทุกงวด)
- ทุกงวดต้องชำระเงินต้น ยกเว้นงวดที่ตัวเองเปีย
- งวดที่เปีย จะได้รับเงินกองกลางแทน
```

### คำนวณสถานะการชำระของแต่ละคน

```
สำหรับแต่ละสมาชิก:
  สำหรับแต่ละงวด:
    ถ้า สมาชิกเปียในงวดนี้:
      status = 'WON'
      amount = 0  (ได้รับเงินแทน)
    ถ้า งวดนี้เสร็จสิ้นแล้ว:
      status = 'PAID'
      amount = principalAmount
    มิฉะนั้น:
      status = 'PENDING'
      amount = principalAmount
```

### สรุปยอดต้องชำระ

```
totalPayment = (จำนวนงวด - 1) × เงินต้น
             = (5 - 1) × 10,000 = 40,000 บาท
             (หัก 1 งวดที่ตัวเองเปีย)
```

---

## Share Format (LINE/Copy)

```
📅 ตารางวันที่ต้องชำระ
วง: วงออมทรัพย์หมู่บ้าน
เงินต้น: 10,000 บาท/งวด

งวด 1: 15 ม.ค. 68 - ป้าแดง (ท้าว)
งวด 2: 15 ก.พ. 68 - รอ
งวด 3: 15 มี.ค. 68 - รอ
งวด 4: 15 เม.ย. 68 - รอ
งวด 5: 15 พ.ค. 68 - รอ

💡 ทุกคนต้องชำระ 10,000 บาท ทุกงวด
   ยกเว้นงวดที่ตัวเองเปีย
```

---

## Technical Notes

- ตารางจะสร้างหลังจากเปิดวง (rounds ถูกสร้างแล้ว)
- ใช้ข้อมูลจาก Round model ที่มีอยู่
- ไม่ต้องสร้าง table ใหม่ เป็นการ query และ format ข้อมูลเท่านั้น
- สถานะ WON = เปียงวดนี้ ได้รับเงินแทนการชำระ
- ทุกคนมีรายการชำระครบทุกงวด (จำนวนงวด = จำนวนสมาชิก)

---

## Future Enhancements

- [ ] ส่ง notification แจ้งเตือนก่อนวันชำระ
- [ ] Export เป็น PDF
- [ ] แสดง QR Code สำหรับชำระเงิน
- [ ] Integration กับ LINE OA
